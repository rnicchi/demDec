package it.mef.bilancio.demdec.manager.impl;

import static it.mef.bilancio.demdec.utils.Constants.FAD_EXISTS;
import static it.mef.bilancio.demdec.utils.Constants.PATR_EXISTS;
import it.almavivaitalia.bilancio.commons.bo.AnagAmminDemBO;
import it.almavivaitalia.bilancio.commons.bo.AnagAmminDemBOId;
import it.almavivaitalia.bilancio.commons.bo.AnagCdrDemBO;
import it.almavivaitalia.bilancio.commons.bo.AnagCdrDemBOId;
import it.almavivaitalia.bilancio.commons.bo.AnagTipoDecretoBO;
import it.almavivaitalia.bilancio.commons.bo.AnagTipologiaDecretoBO;
import it.almavivaitalia.bilancio.commons.bo.AnagUfficiBO;
import it.almavivaitalia.bilancio.commons.bo.DocumentiBO;
import it.almavivaitalia.bilancio.commons.bo.DocumentiBOId;
import it.almavivaitalia.bilancio.commons.bo.DocumentiRedBO;
import it.almavivaitalia.bilancio.commons.bo.DocumentiRedBOId;
import it.almavivaitalia.bilancio.commons.bo.FascicoliBO;
import it.almavivaitalia.bilancio.commons.bo.IterFirmaDecretoBO;
import it.almavivaitalia.bilancio.commons.bo.IterFirmaDecretoBOId;
import it.almavivaitalia.bilancio.commons.bo.SottoFascicoliRedBO;
import it.almavivaitalia.bilancio.commons.bo.SottoFascicoliRedBOId;
import it.almavivaitalia.bilancio.commons.dao.UtenteDao;
import it.almavivaitalia.bilancio.commons.to.AnagAmminDemTO;
import it.almavivaitalia.bilancio.commons.to.AnagUfficiTO;
import it.almavivaitalia.bilancio.commons.to.CodeDescriptionTO;
import it.almavivaitalia.bilancio.commons.to.CroTransTO;
import it.almavivaitalia.bilancio.commons.to.EmailUtenteTO;
import it.almavivaitalia.bilancio.commons.to.UtenteTO;
import it.almavivaitalia.bilancio.commons.web.security.Utente;
import it.almavivaitalia.bsn.sh.manager.exception.ObjectNotFoundException;
import it.almavivaitalia.bsn.sh.utils.ParseUtil;
import it.mef.bilancio.demdec.manager.GestioneFadManager;
import it.mef.bilancio.demdec.manager.IterFirmaDecretoManager;
import it.mef.bilancio.demdec.manager.MailManager;
import it.mef.bilancio.demdec.servizi.client.DEMBILConstants;
import it.mef.bilancio.demdec.servizi.client.InterfacciaAttoDecretoDEMBILClient;
import it.mef.bilancio.demdec.servizi.client.ParametriInput;
import it.mef.bilancio.demdec.servizi.client.RequestDEMBILClient;
import it.mef.bilancio.demdec.servizi.client.ResponseDEMBILClient;
import it.mef.bilancio.demdec.servizi.to.EsitoTO;
import it.mef.bilancio.demdec.servizi.to.FadDemBilTO;
import it.mef.bilancio.demdec.to.AmminRagDemTO;
import it.mef.bilancio.demdec.to.AnagTipologiaDecretoTO;
import it.mef.bilancio.demdec.to.DocumentiRedTO;
import it.mef.bilancio.demdec.to.DocumentiTO;
import it.mef.bilancio.demdec.to.FascicoliTO;
import it.mef.bilancio.demdec.to.GestioneFadTO;
import it.mef.bilancio.demdec.to.SottoFascicoliRedTO;
import it.mef.bilancio.demdec.to.StrumentoTO;
import it.mef.bilancio.demdec.utils.Constants;
import it.mef.bilancio.demdec.utils.ErrorCode;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.UUID;

import org.apache.commons.collections.CollectionUtils;
import org.springframework.beans.factory.annotation.Autowired;

public abstract class GestioneFadParentManagerImpl extends GestioneFadGrandParentManagerImpl 	implements GestioneFadManager {
	
	
	
	@Autowired
	private UtenteDao utenteDao;

	@Autowired 
	private MailManager mailManager;

	@Autowired
	private IterFirmaDecretoManager iterFirmaDecretoManager;
	
	
	public UtenteDao getUtenteDao() {
		return utenteDao;
	}

	public MailManager getMailManager() {
		return mailManager;
	}


	@Override
	public EsitoTO creaFAD( GestioneFadTO to ) throws Throwable{
		
		ParametriInput parametri = leggiParametriInputDemBil();
		FascicoliBO fascicolo = getFascicoloDao().findFascicoloByAnnoTipoNum(to.getAnnoDec(), to.getTipoDec(), to.getNumeroDec());
		if (fascicolo!=null && fascicolo.getId()!=null ){
			// esite già un fascicolo per il decreto 
			return new EsitoTO(DEMBILConstants.ESITO_KO_ERR, FAD_EXISTS) ;
		}
		
		if (to.getChiamante().equalsIgnoreCase(Constants.CREAZIONE_GESTIONE_FAD_CHIAMANTE_DEMDEC)){
			StrumentoTO strum = getStrumentoDemDao().findDecretoByAnnoTipoNum(to.getAnnoDec(), to.getTipoDec(), to.getNumeroDec());
			if (strum.getNumeNum()!=null && !it.almavivaitalia.bsn.sh.utils.StringUtil.isEmpty(to.getNumPatr()) && !to.getNumPatr().equals(strum.getNumePatr()) ){
				//esiste già un decreto sul sistema gestionale collegato a un diverso numero di prelevamento patrimonio.
				return new EsitoTO(DEMBILConstants.ESITO_KO_ERR, PATR_EXISTS) ;
			}
	
		}
		ResponseDEMBILClient resp= invocaCreaFadWs(to, parametri);
		
		return resp.getEsitoTo();
	}

	@Override
	public EsitoTO eliminaAllegatoFAD(FascicoliTO to) throws Throwable {
		ParametriInput parametri = leggiParametriInputDemBil();
		InterfacciaAttoDecretoDEMBILClient interfaccia=new InterfacciaAttoDecretoDEMBILClient();
		RequestDEMBILClient requestDEMBILClient = new RequestDEMBILClient(parametri);
		requestDEMBILClient.setIdFascicolo(to.getCodiGuidFascicolo());
		EsitoTO esitoTo=null;
		
		if(to.getSottoFascicoliRedList()!=null&&to.getSottoFascicoliRedList().size()>0){
			for(SottoFascicoliRedTO doc:to.getSottoFascicoliRedList()){
				
				if(doc.getDocumentiRedList()!=null && doc.getDocumentiRedList().size()>0){
					for(DocumentiRedTO docRed:doc.getDocumentiRedList()){
						requestDEMBILClient.setIdDocumento(docRed.getCodiGuidDocumentoOrig());
						ResponseDEMBILClient resp= interfaccia.removeDocumentoAllegatoDecretoIGB(requestDEMBILClient);
						esitoTo=resp.getEsitoTo();
						
						// PER TEST COMMENTATA PERCHE' TESTATA 
						//esitoTo.setCodice("OK");
						
						if (esitoTo.getCodice().equals(DEMBILConstants.ESITO_OK)){
							// CANCELLAZIONE D_DOCUMENTI_RED
							DocumentiRedBOId boId = new DocumentiRedBOId();
							boId.setFkNumeIdFascicolo(docRed.getId().getFkNumeIdFascicolo());
							boId.setCodiGuidDocumento(docRed.getId().getCodiGuidDocumento());
							DocumentiRedBO bo = getDocumentiRedDao().loadById(DocumentiRedBO.class, boId);
							if (bo!=null){
								getDocumentiRedDao().delete(bo);
								// CANCELLAZIONE D_SOTTO_FASCICOLI_RED
								SottoFascicoliRedBOId sottoBoId = new SottoFascicoliRedBOId();
								sottoBoId.setFkNumeIdFascicolo(doc.getId().getFkNumeIdFascicolo());
								sottoBoId.setCodiIdRed(doc.getId().getCodiIdRed());
								SottoFascicoliRedBO sottoBo = getSottoFascicoliRedDao().loadById(SottoFascicoliRedBO.class, sottoBoId);
								// SE DOPO LA CANCELLAZIONE DEL DOCUMENTO NON HO PIU' DOCUMENTI NEL SOTTOFASCICOLO CANCELLO
								if (sottoBo!=null&&sottoBo.getDocumentiRedList().size()==0){
									getSottoFascicoliRedDao().delete(sottoBo);
									
									// Set stato fascicolo aperto
									changeStatoFascicoloRaccoltaProvvisoria(sottoBo.getCodiGuidFascicolo(), Constants.STATO_FASCICOLO_APERTO.toString());
									
									// Richiamo cronologico
									getCronologicoManager().salvaCronologico(bo,//old
																null,//new
																null,
																null,
																CroTransTO.CRO_TRANS_CANCELLAZIONE_DOCUMENTO_RED,
																to.getRowUpdatedForm()==null?to.getRowCreatedForm():to.getRowUpdatedForm(), 
																to.getRowUpdatedUser()==null?to.getRowCreatedUser():to.getRowUpdatedUser());
									
								}
							}
						}
					}
				}
			}
		}
		
		return esitoTo;
	}

	@Override
	public EsitoTO eliminaDocumentoFAD(FascicoliTO to) throws Throwable {
		// TODO Gestione base dati
		ParametriInput parametri = leggiParametriInputDemBil();
		InterfacciaAttoDecretoDEMBILClient interfaccia=new InterfacciaAttoDecretoDEMBILClient();
		RequestDEMBILClient requestDEMBILClient = new RequestDEMBILClient(parametri);
		requestDEMBILClient.setIdFascicolo(to.getCodiGuidFascicolo());
		EsitoTO esitoTo=null;
		
		if(to.getDocumentiList()!=null&&to.getDocumentiList().size()>0){
			for(DocumentiTO doc:to.getDocumentiList()){
				requestDEMBILClient.setIdDocumento(doc.getCodiGuidDocumentoOrig());
				ResponseDEMBILClient resp= interfaccia.removeDocumentoFascicoloAttoDecreto(requestDEMBILClient);
				esitoTo=resp.getEsitoTo();
				
				// PER TEST COMMENTATA PERCHE' TESTATA 
				//esitoTo.setCodice("OK");
				
				if (esitoTo.getCodice().equals(DEMBILConstants.ESITO_OK)){
					// CANCELLAZIONE D_DOCUMENTI
					DocumentiBOId boId = new DocumentiBOId();
					boId.setFkNumeIdFascicolo(doc.getId().getFkNumeIdFascicolo());
					boId.setNumeIdDocumento(doc.getId().getNumeIdDocumento());
					DocumentiBO bo = getFascicoloDao().loadById(DocumentiBO.class, boId);
					getFascicoloDao().delete(bo);
				}
			}
		}
		
		return esitoTo;
	}

	@Override
	public EsitoTO eliminaFAD(FascicoliTO to) throws Throwable {
		EsitoTO esitoTo=null;
		// CANCELLAZIONE DELLA D_SOTTO_FASCICOLI_RED e D_DOCUMENTI_RED CON RICHIAMO SERVIZIO
		esitoTo=eliminaAllegatoFAD(to);
		if (esitoTo==null||esitoTo.getCodice().equals(DEMBILConstants.ESITO_OK)){
			// CANCELLAZIONE DELLA D_DOCUMENTI CON RICHIAMO SERVIZIO
			esitoTo=eliminaDocumentoFAD(to);
		}
		if (esitoTo==null||esitoTo.getCodice().equals(DEMBILConstants.ESITO_OK)){
			// CANCELLAZIONE DELLA D_FASCICOLI E TABELLE DIPENDENTI CON RICHIAMO SERVIZIO
			esitoTo=eliminaFascicoloFAD(to);
		}		
		return esitoTo;
	}

	@Override
	public EsitoTO eliminaFascicoloFAD(FascicoliTO to) throws Throwable {
		// TODO Gestione base dati
		ParametriInput parametri = leggiParametriInputDemBil();
		InterfacciaAttoDecretoDEMBILClient interfaccia=new InterfacciaAttoDecretoDEMBILClient();
		RequestDEMBILClient requestDEMBILClient = new RequestDEMBILClient(parametri);
		requestDEMBILClient.setIdFascicolo(to.getCodiGuidFascicolo());
		ResponseDEMBILClient resp= interfaccia.removeFascicoloAttoDecreto(requestDEMBILClient);
		if (resp.getEsitoTo().getCodice().equals(DEMBILConstants.ESITO_OK)){
			// CANCELLAZIONE D_FASCICOLI, D_FASCICOLI_AMM, D_FASCICOLI_CDR, D_FASCICOLI_RAG, D_ITER_FIRMA_DECRETO
			// CANCELLAZIONE D_ITER_FIRMA_DECRETO
			IterFirmaDecretoBOId iterId = new IterFirmaDecretoBOId();
			iterId.setFkNumeIdFascicolo(to.getId());
			IterFirmaDecretoBO iter = getFascicoloDao().loadById(IterFirmaDecretoBO.class, iterId);
			if (iter!=null){
				getFascicoloDao().delete(iter);
			}
			
			// CANCELLAZIONE D_FASCICOLI, D_FASCICOLI_AMM, D_FASCICOLI_CDR, D_FASCICOLI_RAG
			FascicoliBO bo = getFascicoloDao().loadById(FascicoliBO.class, to.getId());
			getFascicoloDao().delete(bo);
		}
		return resp.getEsitoTo();
	}

	@Override
	public AmminRagDemTO findAmminRagDemByAnagAmminDemTO( AnagAmminDemTO anagAmminDemTO) throws Throwable {
		return getDozerDriver().map(getAmminRagDemDao().findAmminRagDemByAnagAmminDemTO(anagAmminDemTO), AmminRagDemTO.class, "AmmRag");
	}

	@Override
	public FascicoliTO findFascicoloByAnnoTipoNum(Integer anno, Integer tipo, Integer numDec) throws Throwable {	
		FascicoliBO bo=getFascicoloDao().findFascicoloByAnnoTipoNum(anno, tipo, numDec);
		FascicoliTO to=null;
		if(bo!=null){
			to=getDozerDriver().map(bo, FascicoliTO.class, "FascicoloFad");	
		}else{
			throw new ObjectNotFoundException("Fascicolo non trovato", ErrorCode.OBJECT_NOT_FOUND_EXCEPTION);
		}
		return to;	
	}

	@Override
	public AnagTipologiaDecretoTO findTipologiaByCodi(String codi)
			throws Throwable {
		AnagTipologiaDecretoBO bo = getAnagTipologiaDecretoDao().loadById(ParseUtil.getInteger(codi));
		return (AnagTipologiaDecretoTO) getDozerDriver().map(bo, AnagTipologiaDecretoTO.class, "AnagTipologiaDecreto");
	}

	@Override
	public AnagUfficiTO findUfficioByCodi(String codi)
			throws Throwable {
		AnagUfficiBO bo = getAnagUfficiDao().loadById(codi);
		return (AnagUfficiTO) getDozerDriver().map(bo, AnagUfficiTO.class, "AnagUffici");
	}

	
	
	@Override
	public EsitoTO revocaSospensioneFascicolo(FascicoliTO src) throws Throwable {
		
		final int RISULTATO_NO_RECORD = 1;
		final int RISULTATO_MAX_3 = 2;
		final int RISULTATO_RECORD_1 = 3;
		final int RISULTATO_TUTTI_2 = 4;
		
		String stato = null;
		EsitoTO esito = null;
		
		FascicoliBO fascicoloBo = getFascicoloDao().loadById(src.getId());
		
		// Se la visibilità CDC del fascicolo è 1
		if(fascicoloBo.getFlagVisibilitaCdc01().equals(new Integer(1))){
			
			// Set dello stato del fascicolo a 6
			fascicoloBo.setStatStato(Constants.STATO_FASCICOLO_6);
			stato = Constants.STATO_FAD_IN_ELABORAZIONE;
			
//			getFascicoloDao().saveOrUpdate(fascicoloBo);
//			esito = changeStatoFascicoloAttoDecreto(src.getCodiGuidFascicolo(), stato);
		}
		else {
			
			String risultato = iterFirmaDecretoManager.findStatoIterFirmaDecretoByIdFascicolo(new Integer(src.getId().toString()));
			
			if(!"error".equalsIgnoreCase(risultato)){
			
				switch (Integer.parseInt(risultato)) {
				
					case RISULTATO_NO_RECORD:
						fascicoloBo.setStatStato(Constants.STATO_FASCICOLO_APERTO);
						stato = Constants.STATO_FAD_APERTO;
						break;
					
					case RISULTATO_MAX_3:
						fascicoloBo.setStatStato(Constants.STATO_FASCICOLO_FIRMA_SOSPESA);
						stato = Constants.STATO_FAD_APERTO;
						break;
						
					case RISULTATO_RECORD_1:
						fascicoloBo.setStatStato(Constants.STATO_FASCICOLO_IN_FIRMA);
						stato = Constants.STATO_FAD_IN_ELABORAZIONE;
						break; 
						
					case RISULTATO_TUTTI_2:
						fascicoloBo.setStatStato(Constants.STATO_FASCICOLO_FIRMATO);
						stato = Constants.STATO_FAD_CHIUSO;
						break;
						
					default:
						
						break;
				}				
				
			}
			else{
				// NOTIFICA ERRORE BASE DATI
				esito = new EsitoTO(DEMBILConstants.ESITO_KO, "Errore nella base dati");
			}
			
		}
		
		if(stato != null ){
			
			// Variazione stato
			fascicoloBo.setRowUpdatedDttm(Calendar.getInstance().getTime());
			fascicoloBo.setRowUpdatedUser(Constants.USER_NSBF_AMM);
			
			getFascicoloDao().saveOrUpdate(fascicoloBo);
			esito = changeStatoFascicoloAttoDecreto(src.getCodiGuidFascicolo(), Constants.STATO_FAD_IN_ELABORAZIONE);
			
			if(esito.equals(DEMBILConstants.ESITO_OK)){
				
				// Invio email PEC
				List<EmailUtenteTO> addressEmailList = utenteDao.findEmailUserPecRichSospensioneByIdFascicolo(new Integer(src.getId().toString()).longValue());
				Utente utente = new Utente(Constants.USER_NSBF_AMM);
				
				for(EmailUtenteTO address : addressEmailList){
					if(address.getFlagEmailPec().equals(new Integer(1))) {
						mailManager.invioPecDaFunzione(Constants.FUNZIONE_REVOCA_RICHIESTA_SOSPENSIONE, utente, address.getEmailUtente());
					}
					else {
						mailManager.invioPeoDaFunzione(Constants.FUNZIONE_REVOCA_RICHIESTA_SOSPENSIONE, utente, address.getEmailUtente());
					}							
				}
			}					
		}
		else{
			esito = new EsitoTO(DEMBILConstants.ESITO_KO, "Errore nella base dati");
		}
		
		return esito;
	}

	@Override
	public EsitoTO riaperturaFascicolo(FascicoliTO src) throws Throwable {
		
		EsitoTO esito = null;
		FascicoliBO fascicoloBo = getFascicoloDao().loadById(src.getId());
		
		// Set dello stato a aperto(0)
		fascicoloBo.setStatStato(Constants.STATO_FASCICOLO_APERTO);
		fascicoloBo.setRowUpdatedDttm(Calendar.getInstance().getTime());
		fascicoloBo.setRowUpdatedUser(Constants.USER_NSBF_AMM);
		getFascicoloDao().saveOrUpdate(fascicoloBo);
		
		// ChangeStatoFascicolo
		esito = changeStatoFascicoloAttoDecreto(src.getCodiGuidFascicolo(), Constants.STATO_FAD_APERTO);
		
		// Controllo esito
		if(esito.equals(DEMBILConstants.ESITO_OK)){
			
			// Lettura documenti di tipo AD01 associato al fascicolo
			List<DocumentiBO> docList = getDocumentiDao().findDocumentiByTipoFascicolo(Constants.TIPO_ATTO_DECRETO, src.getId());
			
			if(docList.size() > 0){					
				
				DocumentiBO docAttDecreto = docList.get(0);
				
				// Eliminazione del documento atto decreto
				ParametriInput parametri = leggiParametriInputDemBil();
				InterfacciaAttoDecretoDEMBILClient interfaccia = new InterfacciaAttoDecretoDEMBILClient();
				RequestDEMBILClient requestDEMBILClient = new RequestDEMBILClient(parametri);
				requestDEMBILClient.setIdDocumento(docAttDecreto.getCodiGuidDocumentoOrig());
				ResponseDEMBILClient resp = interfaccia.removeDocumentoFascicoloAttoDecreto(requestDEMBILClient);
				
				EsitoTO esitoRemoveDocumento = resp.getEsitoTo();
				
				if(esitoRemoveDocumento.equals(DEMBILConstants.ESITO_OK)){
					
					// Si provvede ad eliminare il documento atto decreto dalla base dati
					DocumentiBOId boId = new DocumentiBOId();
					boId.setFkNumeIdFascicolo(docAttDecreto.getId().getFkNumeIdFascicolo());
					boId.setNumeIdDocumento(docAttDecreto.getId().getNumeIdDocumento());
					DocumentiBO bo = getFascicoloDao().loadById(DocumentiBO.class, boId);
					getFascicoloDao().delete(bo);
				}		
			}
			
			// Selezione iter firma da eliminare se presente
			IterFirmaDecretoBOId iterId = new IterFirmaDecretoBOId();
			iterId.setFkNumeIdFascicolo(fascicoloBo.getId());
			
			IterFirmaDecretoBO iter = getFascicoloDao().loadById(IterFirmaDecretoBO.class, iterId);
			
			if (iter != null){
				getFascicoloDao().delete(iter);
			}
			
			
			// Invio email PEC
			List<EmailUtenteTO> addressEmailList = utenteDao.findEmailUserPecRichSospensioneByIdFascicolo(src.getId());
			Utente utente = new Utente(Constants.USER_NSBF_AMM);
			
			for(EmailUtenteTO address : addressEmailList){
				if(address.getFlagEmailPec().equals(new Integer(1))) {
					mailManager.invioPecDaFunzione(Constants.FUNZIONE_SOSPENSIONE_DECRETO, utente, address.getEmailUtente());
				}
				else {
					mailManager.invioPeoDaFunzione(Constants.FUNZIONE_RIAPERTURA_DECRETO, utente, address.getEmailUtente());
				}
				
			}
		}
		
//		return changeStatoFascicoloAttoDecreto(src.getCodiGuidFascicolo(), Constants.STATO_FAD_APERTO);
		return esito;
	}
	
	protected EsitoTO changeStatoFascicoloAttoDecreto(String guidFascicolo, String stato) throws Throwable {
		ParametriInput paramInput = leggiParametriInputDemBil();
		RequestDEMBILClient requestDEMBILClient = new RequestDEMBILClient(paramInput);
		requestDEMBILClient.setIdFascicolo(guidFascicolo);
		requestDEMBILClient.setStatoFascicoloAttoDecreto(stato);
		
		InterfacciaAttoDecretoDEMBILClient client = new InterfacciaAttoDecretoDEMBILClient();
		ResponseDEMBILClient resp= client.changeStatoFascicoloAttoDecreto(requestDEMBILClient);
		
		return resp.getEsitoTo();
	}
	
	protected EsitoTO changeStatoFascicoloRaccoltaProvvisoria(String guidFascicolo, String stato) throws Throwable {
		ParametriInput paramInput = leggiParametriInputDemBil();
		RequestDEMBILClient requestDEMBILClient = new RequestDEMBILClient(paramInput);
		requestDEMBILClient.setIdFascicolo(guidFascicolo);
		requestDEMBILClient.setStatoFascicoloAttoDecreto(stato);
		
		InterfacciaAttoDecretoDEMBILClient client = new InterfacciaAttoDecretoDEMBILClient();
		ResponseDEMBILClient resp= client.changeStatoFascicoloRacoltaProvvisoria(requestDEMBILClient);
		
		return resp.getEsitoTo();
	}
	
	


protected FadDemBilTO popolaFadDemTO (GestioneFadTO to,Integer titolo,List<AmminRagDemTO> ragList ) throws Throwable{
	FadDemBilTO demTO= new FadDemBilTO();
	
	CodeDescriptionTO ufficioCapofila= new CodeDescriptionTO();
	ufficioCapofila.setCode(to.getUfficio());
	ufficioCapofila.setDescription(getAnagUfficiDao().loadById(AnagUfficiBO.class, to.getUfficio()).getDescUfficio()); 
	demTO.setUfficioCapofila(ufficioCapofila);
	
	CodeDescriptionTO ufficioCreatore= new CodeDescriptionTO();
	ufficioCreatore.setCode(to.getUfficioCreatore());
	AnagUfficiBO uffcreatore= getAnagUfficiDao().loadById(AnagUfficiBO.class, to.getUfficioCreatore());
	ufficioCreatore.setDescription(uffcreatore!=null?uffcreatore.getDescUfficio():"");
	demTO.setUfficioCreatore(ufficioCreatore);
	
	CodeDescriptionTO tipologia= new CodeDescriptionTO();
	tipologia.setCode(to.getTipologiaDec().toString());
	tipologia.setDescription(getAnagTipologiaDecretoDao().loadById(AnagTipologiaDecretoBO.class, to.getTipologiaDec()).getDescTipologia());
	demTO.setTipologiaDec(tipologia);
	
	
	CodeDescriptionTO amm= new CodeDescriptionTO();
	if (CollectionUtils.isEmpty(to.getAmmList()) || to.getAmmList().size() > 1){
		amm.setCode(Constants.CODI_MULTI_AMMIN);
		amm.setDescription(Constants.DESC_MULTI_AMMIN);
	}
	else{
		// TODO verificare in debug cosa c'è  
		AnagAmminDemBOId ammId= new AnagAmminDemBOId();
		ammId.setNumeApp((to.getAmmList().get(0).getId().getNumeApp()));
		ammId.setNumeStp((to.getAmmList().get(0).getId().getNumeStp()));
		ammId.setFkAnnoEse(to.getAnnoDec().shortValue());
		amm.setCode(to.getAmmList().get(0).getId().getNumeStpFormatted()+""+to.getAmmList().get(0).getId().getNumeApp());
		amm.setDescription((getFascicoloDao().loadById(AnagAmminDemBO.class, ammId).getDescAmm())); //TODO Usare dao corretto
	}
	demTO.setAmm(amm);
	
	
	
	CodeDescriptionTO ucbRTS= new CodeDescriptionTO();
	
	if (ragList.size()>1){
		ucbRTS.setCode(Constants.CODI_MULTI_RAG);
		ucbRTS.setDescription(Constants.DESC_MULTI_RAG);
	}
	else{
		ucbRTS.setCode(ragList.get(0).getId().getNumeRag().toString());
		ucbRTS.setDescription(ragList.get(0).getId().getNumeRag().toString());
	}
	demTO.setUcbRts(ucbRTS);

	
	CodeDescriptionTO titoloDesc= new CodeDescriptionTO();
	titoloDesc.setCode(titolo.toString());
	titoloDesc.setDescription(titolo.toString());
	demTO.setTitolo(titoloDesc);
	
	CodeDescriptionTO cdr= new CodeDescriptionTO();
	AnagCdrDemBOId cdrId= new AnagCdrDemBOId();
	if (to.getCdrList() == null || to.getCdrList().size() == 0){
		cdr.setCode(Constants.CODI_NO_CDR);
		cdr.setDescription(Constants.DESC_NO_CDR);
	}else if (to.getCdrList().size()>1){
		cdr.setCode(Constants.CODI_MULTI_CDR);
		cdr.setDescription(Constants.DESC_MULTI_CDR);
		
	}else{
		// TODO verificare in debug cosa c'è
		cdrId.setFkNumeApp((to.getAmmList().get(0).getId().getNumeApp()));
		cdrId.setFkNumeStp((to.getAmmList().get(0).getId().getNumeStp()));
		cdrId.setFkAnnoEse(to.getAnnoDec().shortValue());
		cdrId.setNumeCdr(to.getCdrList().get(0).getId().getNumeCdr().shortValue());
		cdr.setCode(cdrId.getNumeCdr().toString());
		cdr.setDescription((getFascicoloDao().loadById(AnagCdrDemBO.class, cdrId).getDescCdr()));  //TODO Usare dao corretto
		
	}
	
	demTO.setCdr(cdr);
	
	
	CodeDescriptionTO utenteCreatore= new CodeDescriptionTO();
	utenteCreatore.setCode(to.getCodiUtente());
	utenteCreatore.setDescription(to.getCodiUtente());
	demTO.setUtenteCreatore(utenteCreatore);
	
	demTO.setChiamante(to.getChiamante());
	demTO.setTipoDec(to.getTipoDec()); // DMT o DIM
	demTO.setNumeroDec(to.getNumeroDec());
	demTO.setDescDec(to.getDescDec());
	demTO.setAnnoDec(to.getAnnoDec());
	demTO.setStatoFascicolo(Constants.STATO_FASCICOLO_APERTO.toString());
	demTO.setFlagNormativo(to.getFlagNormativo());
	demTO.setGuid(UUID.randomUUID().toString());
	
	
	CodeDescriptionTO siglaTipoDec= new CodeDescriptionTO();
	siglaTipoDec.setCode(to.getTipoDec().toString());
	siglaTipoDec.setDescription((getFascicoloDao().loadById(AnagTipoDecretoBO.class, to.getTipoDec()).getDescSigla())); //TODO Usare dao corretto
	
	demTO.setSiglaTipoDec(siglaTipoDec);
	Integer numPatr= to.getNumPatr();
	demTO.setNumPatr(numPatr);
	
	if (numPatr!=null){
		String guidPatr=getvBilDecretiDao().findGuidSiPatrBynumPatr(numPatr,to.getAnnoDec());
		demTO.setGuidSiPatr(guidPatr);
	}
	
	return demTO;
}


protected ResponseDEMBILClient invocaCreaFadWs( GestioneFadTO to,ParametriInput parametri) throws Throwable{
	
	Integer titolo=Constants.CODI_TITOLO_DEFAULT; //TODO chiedere il valore da usare
	List<AmminRagDemTO> ragList= new ArrayList<AmminRagDemTO>();
	for (AnagAmminDemTO amm : to.getAmmList()) {
		AmminRagDemTO rag= getDozerDriver().map(getAmminRagDemDao().findAmminRagDemByAnagAmminDemTO(amm), AmminRagDemTO.class, "AmmRag");
		ragList.add(rag);
	}

	// faccio query corrispondenza utente demdec e NSBF se non esiste scrivo NSBF-utente, altrimenti se DEMDEC le info sono già nel TO
	if (to.getChiamante().equalsIgnoreCase(Constants.CREAZIONE_GESTIONE_FAD_CHIAMANTE_NSBF)){
		UtenteTO utNsbf=getUtenteManager().loadByCodiUtenteNsbf(to.getCodiUtente());
		if (utNsbf==null){
			to.setCodiUtente("NSBF-"+to.getCodiUtente());
			to.setUfficioCreatore(Constants.UFFICIO_CREATORE_COORDINAMENTO);
		}
		else{
			to.setCodiUtente(utNsbf.getCodiUtente());
			to.setUfficioCreatore(utNsbf.getUtenteProfiloPrincipale().getAnagUffici().getId());
		}
	}else{
		to.setCodiUtente(to.getCodiUtente());
		to.setUfficioCreatore(to.getUfficioCreatore());
	}
	
	//  chiamo il servizio createFascicoloAttoDecreto e ottengo il GUID
	FadDemBilTO demTo= popolaFadDemTO(to, titolo, ragList);
	InterfacciaAttoDecretoDEMBILClient interfaccia=new InterfacciaAttoDecretoDEMBILClient();
	ResponseDEMBILClient resp= interfaccia.createFascicoloAttoDecreto(new RequestDEMBILClient(parametri, demTo,null));
	
	// PER FARLO ANDARE AVANTI 
	//resp.getEsitoTo().setCodice("OK");
	
	if (resp.getEsitoTo().getCodice().equals(DEMBILConstants.ESITO_OK)){
		saveFascicolo(ragList, to, resp);
	}
	
	return resp;
}

	
}
